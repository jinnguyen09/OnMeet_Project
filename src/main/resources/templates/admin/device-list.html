<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8"/>
    <title>Quản lý Thiết bị | Admin</title>
    <div th:replace="~{layouts/admin-head :: admin-head}"></div>

    <style>
        .toolbar { display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
        .left-actions { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

        #deviceFormPanel {
            display:none;
            margin-top: 14px;
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        }
        .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .form-grid .full { grid-column: 1 / -1; }

        label { display:block; font-weight: 600; margin-bottom: 6px; color:#334155; }

        .field, select.field {
            width:100%;
            padding: 10px 12px;
            border:1px solid #cbd5e1;
            border-radius: 10px;
            box-sizing: border-box;
            outline: none;
            background: #fff;
        }
        .field:focus, select.field:focus {
            border-color:#2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
        }

        select.field {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image:
                    linear-gradient(45deg, transparent 50%, #64748b 50%),
                    linear-gradient(135deg, #64748b 50%, transparent 50%),
                    linear-gradient(to right, transparent, transparent);
            background-position:
                    calc(100% - 18px) calc(1em + 2px),
                    calc(100% - 13px) calc(1em + 2px),
                    calc(100% - 2.5em) 0.5em;
            background-size:
                    5px 5px,
                    5px 5px,
                    1px 1.8em;
            background-repeat: no-repeat;
        }

        .muted { color:#64748b; font-size: 13px; }

        .msg { margin: 10px 0; padding: 10px 12px; border-radius: 10px; }
        .msg.success { background: #eaffea; color: #0f5132; border: 1px solid #b7f0c2; }

        .actions a { margin-right: 10px; }

        @media (max-width: 720px) {
            .form-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>

<div th:replace="~{layouts/admin-navbar :: admin-navbar}"></div>

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Quản lý thiết bị</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Quản lý thiết bị</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">

            <div class="col-lg-12">

                <div class="card">
                    <div class="card-body">

                        <div class="msg success" th:if="${success}" th:text="${success}"></div>

                        <div class="toolbar mt-3">
                            <div class="left-actions">
                                <button class="btn btn-primary" type="button" onclick="openAdd()">
                                    <i class="bi bi-plus-circle"></i> Thêm thiết bị
                                </button>

                                <a class="btn btn-outline-secondary" th:href="@{/admin/devices}">
                                    <i class="bi bi-list-ul"></i> Tất cả
                                </a>

                                <a class="btn btn-outline-success" th:href="@{/admin/devices/available}">
                                    <i class="bi bi-check2-circle"></i> Thiết bị có sẵn
                                </a>
                            </div>

                            <div class="muted">
                                Tip: bấm “Sửa” để mở form ngay trên trang.
                            </div>
                        </div>

                        <div id="deviceFormPanel">
                            <h5 id="formTitle" class="card-title" style="margin:0 0 10px;">Thêm thiết bị</h5>

                            <form id="deviceForm" method="post" th:object="${device}">
                                <input type="hidden"
                                       th:if="${_csrf != null}"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}"/>

                                <input type="hidden" id="deviceId" th:field="*{id}"/>

                                <div class="form-grid">
                                    <div class="full">
                                        <label for="name">Tên thiết bị</label>
                                        <input class="field" id="name" th:field="*{name}" placeholder="VD: Máy chiếu" required/>
                                    </div>

                                    <div>
                                        <label for="type">Phân loại</label>
                                        <input class="field" id="type" th:field="*{type}" placeholder="VD: PROJECTOR"/>
                                    </div>

                                    <div>
                                        <label for="status">Trạng thái</label>
                                        <select class="field" id="status" th:field="*{status}">
                                            <option value="">-- Chọn trạng thái --</option>
                                            <option value="AVAILABLE">Available</option>
                                            <option value="MAINTENANCE">Maintenance</option>
                                            <option value="OUT_OF_STOCK">Out of stock</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label for="quantity">Số lượng</label>
                                        <input class="field" id="quantity" th:field="*{quantity}" type="number" min="0" placeholder="0"/>
                                    </div>

                                    <div class="full muted" id="editHint" style="display:none;">
                                        Bạn đang sửa thiết bị ID: <b id="editIdText"></b>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn btn-primary" type="submit" id="submitBtn">
                                        <i class="bi bi-check-circle"></i> Thêm
                                    </button>
                                    <button class="btn btn-outline-secondary" type="button" onclick="closeForm()">
                                        Hủy
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="card bg-light border-0 shadow-sm mt-3">
                            <div class="card-body py-3">
                                <form th:action="@{/admin/devices/search}" method="get" class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" name="name" class="field"
                                               placeholder="Tìm theo tên..." th:value="${searchName}">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" name="type" class="field"
                                               placeholder="Tìm theo loại (Type)..." th:value="${searchType}">
                                    </div>
                                    <div class="col-md-3">
                                        <select name="status" class="field">
                                            <option value="">-- Tất cả trạng thái --</option>
                                            <option value="AVAILABLE" th:selected="${searchStatus == 'AVAILABLE'}">Available</option>
                                            <option value="MAINTENANCE" th:selected="${searchStatus == 'MAINTENANCE'}">Maintenance</option>
                                            <option value="OUT_OF_STOCK" th:selected="${searchStatus == 'OUT_OF_STOCK'}">Out of stock</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2 d-grid">
                                        <button type="submit" class="btn btn-dark">
                                            <i class="bi bi-search"></i> Lọc
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <hr class="my-4"/>

                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th style="width:80px;">ID</th>
                                    <th>Tên</th>
                                    <th style="width:180px;">Phân loại</th>
                                    <th style="width:170px;">Trạng thái</th>
                                    <th style="width:120px;">Số lượng</th>
                                    <th style="width:180px;">Hành động</th>
                                </tr>
                                </thead>

                                <tbody>
                                <tr th:each="d : ${devices}">
                                    <td th:text="${d.id}"></td>
                                    <td class="fw-semibold" th:text="${d.name}"></td>
                                    <td th:text="${d.type}"></td>

                                    <td>
                                        <span class="badge bg-success" th:if="${d.status == 'AVAILABLE'}" th:text="${d.status}"></span>
                                        <span class="badge bg-warning text-dark" th:if="${d.status == 'MAINTENANCE'}" th:text="${d.status}"></span>
                                        <span class="badge bg-danger" th:if="${d.status == 'OUT_OF_STOCK'}" th:text="${d.status}"></span>
                                        <span class="badge bg-secondary" th:if="${d.status != 'AVAILABLE' and d.status != 'MAINTENANCE' and d.status != 'OUT_OF_STOCK'}"
                                              th:text="${d.status}"></span>
                                    </td>

                                    <td th:text="${d.quantity}"></td>

                                    <td class="actions">
                                        <a class="btn btn-sm btn-outline-primary"
                                           href="javascript:void(0)"
                                           th:attr="data-id=${d.id},
                                            data-name=${d.name},
                                            data-type=${d.type},
                                            data-status=${d.status},
                                            data-qty=${d.quantity}"
                                           onclick="openEdit(this)">
                                            Sửa
                                        </a>

                                        <a class="btn btn-sm btn-outline-danger"
                                           th:href="@{/admin/devices/delete/{id}(id=${d.id})}"
                                           onclick="return confirm('Xóa thiết bị này?')">
                                            Xóa
                                        </a>
                                    </td>
                                </tr>

                                <tr th:if="${#lists.isEmpty(devices)}">
                                    <td colspan="6" class="text-center text-muted py-4">Không có thiết bị</td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>

            </div>

        </div>
    </section>

</main>

<div th:replace="~{layouts/admin-footer :: admin-footer}"></div>

<script>
    function openAdd() {
        document.getElementById("formTitle").innerText = "Thêm thiết bị";
        document.getElementById("submitBtn").innerHTML = '<i class="bi bi-check-circle"></i> Thêm';
        document.getElementById("deviceForm").action = "/admin/devices/add";

        document.getElementById("deviceId").value = "";
        document.getElementById("name").value = "";
        document.getElementById("type").value = "";
        document.getElementById("status").value = "";
        document.getElementById("quantity").value = 0;

        document.getElementById("editHint").style.display = "none";
        document.getElementById("editIdText").innerText = "";

        document.getElementById("deviceFormPanel").style.display = "block";
        document.getElementById("name").focus();
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function openEdit(el) {
        const id = el.dataset.id;

        document.getElementById("formTitle").innerText = "Sửa thiết bị";
        document.getElementById("submitBtn").innerHTML = '<i class="bi bi-check-circle"></i> Cập nhật';
        document.getElementById("deviceForm").action = "/admin/devices/edit/" + id;

        document.getElementById("deviceId").value = id;
        document.getElementById("name").value = el.dataset.name || "";
        document.getElementById("type").value = el.dataset.type || "";
        document.getElementById("status").value = el.dataset.status || "";
        document.getElementById("quantity").value = el.dataset.qty || 0;

        document.getElementById("editHint").style.display = "block";
        document.getElementById("editIdText").innerText = id;

        document.getElementById("deviceFormPanel").style.display = "block";
        document.getElementById("name").focus();
        window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function closeForm() {
        document.getElementById("deviceFormPanel").style.display = "none";
    }
</script>

</body>
</html>

