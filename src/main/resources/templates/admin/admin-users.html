<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Quản lý người dùng</title>
    <div th:replace="~{layouts/admin-head :: admin-head}"></div>
    <style>
        .modal-header { background-color: #f8f9fa; border-bottom: 2px solid #dee2e6; }
        .form-label { font-weight: 600; }
        .badge-admin { background-color: #0d6efd; color: white; }
        .badge-user { background-color: #6c757d; color: white; }
    </style>
</head>

<body>

<div th:replace="~{layouts/admin-navbar :: admin-navbar}"></div>

<main id="main" class="main">

    <div class="pagetitle">
        <h1>Quản lý người dùng</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Trang chủ</a></li>
                <li class="breadcrumb-item active">Quản lý người dùng</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">

                        <div class="d-flex justify-content-between align-items-center mb-4 mt-2">
                            <h5 class="card-title mb-0">Danh sách người dùng</h5>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#userModal"
                                    onclick="openModal('add')">
                                <i class="bi bi-plus-circle"></i> Thêm người dùng
                            </button>
                        </div>

                        <div class="table-responsive">

                            <div class="bg-light p-3 rounded mb-4 border">
                                <form th:action="@{/admin/users}" method="GET" class="row g-3">
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
                                            <input type="text" name="q" th:value="${param.q}" class="form-control"
                                                   placeholder="Tìm kiếm theo tên, email hoặc số điện thoại...">
                                        </div>
                                    </div>
                                    <div class="col-md-3 d-flex gap-2">
                                        <button type="submit" class="btn btn-primary w-100">Tìm kiếm</button>
                                        <a th:href="@{/admin/users}" class="btn btn-secondary w-100">Reset</a>
                                    </div>
                                </form>
                            </div>

                            <table class="table table-bordered table-hover align-middle">
                                <thead class="table-light">
                                <tr>
                                    <th width="50">#</th>
                                    <th>Họ và tên</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Vai trò</th>
                                    <th width="120">Hành động</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="u : ${userPage.content}">
                                    <td th:text="${u.userId}"></td>
                                    <td th:text="${u.fullname ?: 'N/A'}"></td>
                                    <td th:text="${u.email ?: 'N/A'}"></td>
                                    <td th:text="${u.phone ?: 'N/A'}"></td>
                                    <td>
                                        <span th:each="r : ${u.roles}"
                                              th:text="${r == 'ROLE_ADMIN' ? 'ADMIN' : 'USER'}"
                                              class="badge me-1"
                                              th:classappend="${r == 'ROLE_ADMIN' ? 'badge-admin' : 'badge-user'}">
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning"
                                                data-bs-toggle="modal"
                                                data-bs-target="#userModal"
                                                onclick="openModal('edit', this)"
                                                th:data-id="${u.userId}"
                                                th:data-name="${u.fullname}"
                                                th:data-email="${u.email}"
                                                th:data-phone="${u.phone}"
                                                th:data-password="${u.password}"
                                                th:data-roles="${u.rolesText}">
                                            <i class="bi bi-pencil"></i> Sửa
                                        </button>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div class="text-muted">
                Đang hiển thị trang <span th:text="${userPage.number + 1}"></span> / <span th:text="${userPage.totalPages}"></span>
            </div>
            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item" th:classappend="${!userPage.hasPrevious()} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/users(page=${userPage.number - 1}, q=${q})}">
                            <i class="bi bi-chevron-left"></i> Trước
                        </a>
                    </li>

                    <li class="page-item" th:classappend="${!userPage.hasNext()} ? 'disabled'">
                        <a class="page-link" th:href="@{/admin/users(page=${userPage.number + 1}, q=${q})}">
                            Sau <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

    </section>
</main>

<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Thông tin người dùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <form id="userForm" method="post">
                <div class="modal-body">
                    <div class="row g-3">
                        <input type="hidden" id="userId" name="id">

                        <div class="col-md-6">
                            <label class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="name" name="fullname" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Số điện thoại</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mật khẩu</label>
                            <input type="password" class="form-control" id="password" name="password"
                                   placeholder="Nhập mật khẩu mới">
                        </div>

                        <div class="col-md-12">
                            <label class="form-label d-block">Vai trò hệ thống</label>
                            <div class="d-flex gap-4 flex-wrap border p-3 rounded bg-light">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="ROLE_ADMIN" id="roleAdmin">
                                    <label class="form-check-label" for="roleAdmin">QUẢN TRỊ VIÊN (ADMIN)</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="roles" value="ROLE_USER" id="roleUser">
                                    <label class="form-check-label" for="roleUser">NGƯỜI DÙNG (USER)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div th:replace="~{layouts/admin-footer :: admin-footer}"></div>

<script>
    function openModal(mode, button) {
        const title = document.getElementById('userModalLabel');
        const form = document.getElementById('userForm');

        form.reset();
        document.querySelectorAll('input[name="roles"]').forEach(cb => cb.checked = false);

        if (mode === 'add') {
            title.innerHTML = '<i class="bi bi-plus-circle"></i> Thêm người dùng mới';
            document.getElementById('userId').value = "";
            form.action = "/admin/users/create";
        } else {
            title.innerHTML = '<i class="bi bi-pencil-square"></i> Cập nhật người dùng';

            const userId = button.dataset.id;
            document.getElementById('userId').value = userId;
            document.getElementById('name').value = button.dataset.name || "";
            document.getElementById('email').value = button.dataset.email || "";
            document.getElementById('phone').value = button.dataset.phone || "";
            document.getElementById('password').value = button.dataset.password || "";

            const rolesStr = button.dataset.roles || "";
            const roleSet = new Set(rolesStr.split(',').map(s => s.trim()).filter(Boolean));

            document.querySelectorAll('input[name="roles"]').forEach(cb => {
                cb.checked = roleSet.has(cb.value);
            });

            form.action = `/admin/users/${userId}/roles`;
        }
    }
</script>

</body>
</html>